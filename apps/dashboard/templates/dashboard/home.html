{% extends 'base.html' %}
{% load gnf %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div>
        <h1 class="page-title">Tableau de bord</h1>
        <p class="page-subtitle">Vue d'ensemble de votre restaurant</p>
    </div>
    <div class="btn-group">
        <a href="{% url 'payments:dashboard_caisse' %}" class="btn btn--primary">ğŸ’° GÃ©rer la caisse</a>
        <a href="{% url 'orders:list_orders' %}" class="btn btn--ghost">ğŸ“‹ Voir commandes</a>
        <a href="{% url 'dashboard:export_ventes_excel' %}" class="btn btn--success">ğŸ“Š Export Excel</a>
        <a href="{% url 'dashboard:export_ventes_pdf' %}" class="btn btn--danger">ğŸ“„ Export PDF</a>
    </div>
</div>

<!-- Stats Cards -->
<div class="stats-grid">
    <div class="stat-card stat-card--primary">
        <div class="stat-card__icon">ğŸ’°</div>
        <div class="stat-card__value">{{ ca_today|gnf }}</div>
        <div class="stat-card__label">Chiffre d'affaires aujourd'hui</div>
        {% if ca_week > 0 %}
        <div class="stat-card__trend stat-card__trend--up">ğŸ“ˆ {{ ca_week|gnf }} cette semaine</div>
        {% endif %}
    </div>
    
    <div class="stat-card stat-card--warning">
        <div class="stat-card__icon">â³</div>
        <div class="stat-card__value">{{ commandes_en_attente }}</div>
        <div class="stat-card__label">Commandes en attente</div>
    </div>
    
    <div class="stat-card stat-card--info">
        <div class="stat-card__icon">ğŸ½ï¸</div>
        <div class="stat-card__value">{{ commandes_servies }}</div>
        <div class="stat-card__label">Commandes servies</div>
    </div>
    
    <div class="stat-card stat-card--success">
        <div class="stat-card__icon">âœ…</div>
        <div class="stat-card__value">{{ commandes_payees_today }}</div>
        <div class="stat-card__label">PayÃ©es aujourd'hui</div>
    </div>
</div>

<!-- Second Row Stats -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-card__icon">ğŸª‘</div>
        <div class="stat-card__value">{{ tables_libres }}/{{ tables_total }}</div>
        <div class="stat-card__label">Tables libres</div>
        <div class="progress" style="margin-top: 12px;">
            <div class="progress__bar" style="width: {% widthratio tables_occupees tables_total 100 %}%;"></div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-card__icon">ğŸ“Š</div>
        <div class="stat-card__value">{{ commande_moyenne|gnf }}</div>
        <div class="stat-card__label">Panier moyen (30j)</div>
    </div>
    
    <div class="stat-card stat-card--danger">
        <div class="stat-card__icon">ğŸ“¤</div>
        <div class="stat-card__value">{{ depenses_today|gnf }}</div>
        <div class="stat-card__label">DÃ©penses aujourd'hui</div>
    </div>
    
    {% if caisse %}
    <div class="stat-card stat-card--success">
        <div class="stat-card__icon">ğŸ¦</div>
        <div class="stat-card__value">{{ caisse.solde_actuel|gnf }}</div>
        <div class="stat-card__label">Solde caisse</div>
        <span class="badge badge--success" style="margin-top: 8px;">Caisse ouverte</span>
    </div>
    {% else %}
    <div class="stat-card">
        <div class="stat-card__icon">ğŸ¦</div>
        <div class="stat-card__value">--</div>
        <div class="stat-card__label">Solde caisse</div>
        <span class="badge badge--warning" style="margin-top: 8px;">Caisse fermÃ©e</span>
    </div>
    {% endif %}
</div>

<!-- Charts and Details -->
<div class="grid grid--2">
    <!-- Sales Chart -->
    <div class="card">
        <div class="card__header">
            <div>
                <h3 class="card__title">Ventes des 7 derniers jours</h3>
                <p class="card__subtitle">Ã‰volution du chiffre d'affaires</p>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="salesChart"></canvas>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="card">
        <div class="card__header">
            <h3 class="card__title">Actions rapides</h3>
        </div>
        <div class="quick-actions">
            <a href="{% url 'orders:list_orders' %}?statut=en_attente" class="quick-action">
                <div class="quick-action__icon" style="background: rgba(245, 158, 11, 0.15); color: #f59e0b;">â³</div>
                <span class="quick-action__label">Commandes en attente</span>
            </a>
            <a href="{% url 'tables:list_tables' %}" class="quick-action">
                <div class="quick-action__icon" style="background: rgba(16, 185, 129, 0.15); color: #10b981;">ğŸª‘</div>
                <span class="quick-action__label">GÃ©rer les tables</span>
            </a>
            <a href="{% url 'payments:creer_sortie' %}" class="quick-action">
                <div class="quick-action__icon" style="background: rgba(239, 68, 68, 0.15); color: #ef4444;">ğŸ“¤</div>
                <span class="quick-action__label">Nouvelle dÃ©pense</span>
            </a>
            <a href="{% url 'menu:manage_dishes' %}" class="quick-action">
                <div class="quick-action__icon" style="background: rgba(6, 182, 212, 0.15); color: #06b6d4;">ğŸ´</div>
                <span class="quick-action__label">GÃ©rer le menu</span>
            </a>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="grid grid--2" style="margin-top: 24px;">
    <!-- Recent Orders -->
    <div class="card">
        <div class="card__header">
            <h3 class="card__title">DerniÃ¨res commandes</h3>
            <a href="{% url 'orders:list_orders' %}" class="btn btn--sm btn--ghost">Voir tout</a>
        </div>
        <div class="activity-list">
            {% for commande in dernieres_commandes %}
            <div class="activity-item">
                <div class="activity-item__icon" style="{% if commande.statut == 'en_attente' %}background: rgba(245, 158, 11, 0.15);{% elif commande.statut == 'servie' %}background: rgba(6, 182, 212, 0.15);{% else %}background: rgba(16, 185, 129, 0.15);{% endif %}">
                    {% if commande.statut == 'en_attente' %}â³{% elif commande.statut == 'servie' %}ğŸ½ï¸{% else %}âœ…{% endif %}
                </div>
                <div class="activity-item__content">
                    <div class="activity-item__title">
                        {{ commande.numero_commande }} - Table {{ commande.table.numero_table }}
                    </div>
                    <div class="activity-item__time">{{ commande.date_commande|timesince }}</div>
                </div>
                <div class="activity-item__amount activity-item__amount--positive">
                    {{ commande.montant_total|gnf }}
                </div>
            </div>
            {% empty %}
            <div class="empty-state">
                <p>Aucune commande rÃ©cente</p>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Recent Payments -->
    <div class="card">
        <div class="card__header">
            <h3 class="card__title">Derniers paiements</h3>
            <a href="{% url 'payments:liste_paiements' %}" class="btn btn--sm btn--ghost">Voir tout</a>
        </div>
        <div class="activity-list">
            {% for paiement in derniers_paiements %}
            <div class="activity-item">
                <div class="activity-item__icon" style="background: rgba(16, 185, 129, 0.15);">ğŸ’³</div>
                <div class="activity-item__content">
                    <div class="activity-item__title">
                        {{ paiement.commande.numero_commande }}
                    </div>
                    <div class="activity-item__time">{{ paiement.date_paiement|timesince }} â€¢ {{ paiement.get_mode_paiement_display }}</div>
                </div>
                <div class="activity-item__amount activity-item__amount--positive">
                    +{{ paiement.montant|gnf }}
                </div>
            </div>
            {% empty %}
            <div class="empty-state">
                <p>Aucun paiement rÃ©cent</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Popular Dishes & Recent Expenses -->
<div class="grid grid--2" style="margin-top: 24px;">
    <!-- Popular Dishes -->
    <div class="card">
        <div class="card__header">
            <h3 class="card__title">ğŸ† Plats les plus commandÃ©s</h3>
        </div>
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Plat</th>
                        <th>Commandes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for plat in plats_populaires %}
                    <tr>
                        <td>{{ plat.nom }}</td>
                        <td><span class="badge badge--primary">{{ plat.nb_commandes }}</span></td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="2" class="empty-state">Aucune donnÃ©e</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Recent Expenses -->
    <div class="card">
        <div class="card__header">
            <h3 class="card__title">DerniÃ¨res dÃ©penses</h3>
            <a href="{% url 'payments:creer_sortie' %}" class="btn btn--sm btn--ghost">+ Ajouter</a>
        </div>
        <div class="activity-list">
            {% for depense in dernieres_depenses %}
            <div class="activity-item">
                <div class="activity-item__icon" style="background: rgba(239, 68, 68, 0.15);">ğŸ“¤</div>
                <div class="activity-item__content">
                    <div class="activity-item__title">{{ depense.motif|truncatechars:40 }}</div>
                    <div class="activity-item__time">{{ depense.date_sortie|timesince }} â€¢ {{ depense.type_depense.nom }}</div>
                </div>
                <div class="activity-item__amount activity-item__amount--negative">
                    -{{ depense.montant|gnf }}
                </div>
            </div>
            {% empty %}
            <div class="empty-state">
                <p>Aucune dÃ©pense rÃ©cente</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('salesChart');
    if (ctx) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ chart_labels|safe }},
                datasets: [{
                    label: 'Chiffre d\'affaires (GNF)',
                    data: {{ chart_data|safe }},
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#3b82f6',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: '#1e293b',
                        titleColor: '#f1f5f9',
                        bodyColor: '#94a3b8',
                        borderColor: 'rgba(148, 163, 184, 0.2)',
                        borderWidth: 1,
                        cornerRadius: 8,
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y + ' GNF';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: 'rgba(148, 163, 184, 0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            color: '#64748b'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(148, 163, 184, 0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            color: '#64748b',
                            callback: function(value) {
                                return value + ' GNF';
                            }
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}
